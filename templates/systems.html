{% extends "layout.html" %}
{% block body %}

<style type="text/css">
a.server-link { text-decoration: none !important; color: inherit; }
a.server-link:hover { text-decoration: underline !important; }
</style>

<div class="page-header">
{#	<div class="pull-right" style="display:none"><button id="showdecom" type="button" class="btn btn-success btn-sm">Show Decommissioned Systems</button></div>#}
<h3><i class="fa fa-server fa-fw"></i> Systems<a class="btn btn-primary btn-sm pull-right" href="{{ url_for('systems_download_csv') }}"><i class="fa fa-fw fa-download"></i> Download CSV</a></h3>
</div>

<ul id="class-tabs" class="nav nav-tabs" style="margin-bottom:1em">
	{%- for class in classes %}
	<li {% if loop.index0 == 0 %}class="active" {% endif %}role="presentation"><a style="cursor:pointer" data-class="{{ class.name }}" role="tab">{{ class.name }}</a></li>
	{%- endfor %}
	<li role="presentation"><a style="cursor:pointer" data-class="*OTHER" role="tab">Other/Legacy</a></li>
	<li role="presentation"><a style="cursor:pointer" data-class="*ALL" role="tab">All</a></li>
</ul>
<div id="systemsWrapper">
<table class="table table-condensed table-striped" id="systems">
	<thead>
		<tr>
			<th><div class="tablesorter-inner">Name</div></th>
			<th><div class="tablesorter-inner">Comment</div></th>
			<th><div class="tablesorter-inner">Allocated By</div></th>
			<th width="150px"><div class="tablesorter-inner">Allocation Date</div></th>
			<th width="100px"><div class="tablesorter-inner">CI Status</div></th>
			<th width="130px"></th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</div>
<script type="text/javascript">
var CMDB_URL_FORMAT = "{{ config['CMDB_URL_FORMAT'] }}";
$(function() {
	var systemsTable = $('#systems').DataTable({
		"lengthMenu": [[10,15,50,100,-1], [10,15,50,100,'All']],
		"pageLength": 15,
		"order": [[0, 'asc']],
		"columns": [null, null, null, null, null, { "orderable": false, "targets": 0 }],
		"serverSide": true,
		"searchDelay": 500,
		"ajax": {
			"url": "{{ url_for('systems_json') }}",
			"data": function (d) {
				d.filter_group = $('#class-tabs li.active a').attr('data-class');
				d.show_decom = ($('#showdecom').hasClass('btn-success') ? "1" : "0");
			}
		},
		"searching": true,
		"rowCallback": function(row, data, index) {
			{#- data[5] is CMDB URL, data[6] is database ID, data[4] is operational status, data[8] is Puppet Cert Name #}
			$('td:eq(5)', row).html((data[8] != null ? '<a class="btn btn-xs btn-default" style="margin-right:0.5em" href="/puppet/enc/' + data[6] + '"><i style="margin-right:0.2em" class="fa fa-fw fa-edit"></i>Puppet</a>': '') + (data[5] != '' ? '<a class="btn btn-xs btn-default" href="' + data[5] + '" target="_blank"><i style="margin-right:0.2em" class="fa fa-fw fa-cloud"></i>CMDB</a>' : ''));
			if (data[4] == "" || data[4] == undefined)
			{
				$('td:eq(4)', row).html("Unknown");
			}

			var view_link = "<a class='server-link' href='/systems/edit/" + data[6] + "'>" + data[0] + "</a>";

			if (data[7] == "poweredOn")
			{
				$('td:eq(0)', row).html("<i style='color:#2c2;font-size:8pt;margin-right:0.3em' class='fa fa-fw fa-play' />" + view_link);
			}
			else if (data[7] == "poweredOff")
			{
				$('td:eq(0)', row).html("<i style='color:#c22;font-size:8pt;margin-right:0.3em' class='fa fa-fw fa-stop' />" + view_link);
			}
			else if (data[7] == "suspended")
			{
				$('td:eq(0)', row).html("<i style='color:#c82;font-size:8pt;margin-right:0.3em' class='fa fa-fw fa-pause' />" + view_link);
			}
			else
			{
				$('td:eq(0)', row).html("<i style='color:#22c;font-size:8pt;margin-right:0.3em' class='fa fa-fw fa-question' />" + view_link);
			}
		}
	});
	$('#class-tabs li').click(function() {
		$('#class-tabs li').removeClass('active');
		$(this).addClass('active');
		$('#systemsWrapper').fadeOut(150, function() {
			systemsTable.ajax.reload(function() {
				$('#systemsWrapper').fadeIn(150);
			});
		});
	});
{#	$('#showdecom').click(function() {
		$('#showdecom').toggleClass('btn-success');
		$('#showdecom').toggleClass('btn-danger');
		$('#systemsWrapper').fadeOut(150, function() {
			systemsTable.ajax.reload(function() {
				$('#systemsWrapper').fadeIn(150);
			});
		});
	}); #}
});
</script>
{% endblock %}
